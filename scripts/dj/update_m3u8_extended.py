#!/usr/bin/env python3
"""
–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ M3U8 —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è DJ Pro AI
–í–∫–ª—é—á–∞–µ—Ç: BPM, Key, Camelot, Energy Level, Genre, Loudness
"""

import json
import logging
from pathlib import Path

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO, format="%(asctime)s | %(levelname)-8s | %(message)s", datefmt="%H:%M:%S"
)
logger = logging.getLogger(__name__)

PROJECT_DIR = Path(__file__).parent
DJ_SET_DIR = PROJECT_DIR / "dj_set_techno_2025"
METADATA_FILE = DJ_SET_DIR / "tracklist_metadata.json"


def generate_extended_m3u8(tracks, output_file):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ M3U8 —Å –ø–æ–ª–Ω—ã–º–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏"""
    lines = ["#EXTM3U"]
    lines.append("# Generated by Yandex Music Downloader + DJ Tools")
    lines.append("# Format: Extended M3U8 for DJ Pro AI / djay Pro")
    lines.append("")

    for track in tracks:
        # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π EXTINF
        duration_sec = int(track["duration_ms"] / 1000) if track.get("duration_ms") else 0
        artist_title = f"{track['artist']} - {track['title']}"
        lines.append(f"#EXTINF:{duration_sec},{artist_title}")

        # –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ç–µ–≥–∏
        if track.get("genre"):
            lines.append(f"#EXTGENRE:{track['genre']}")

        if track.get("bpm"):
            lines.append(f"#EXTBPM:{track['bpm']}")

        if track.get("key"):
            lines.append(f"#EXTKEY:{track['key']}")

        if track.get("camelot"):
            lines.append(f"#EXTCAMELOT:{track['camelot']}")

        if track.get("energy"):
            lines.append(f"#EXTENERGY:{track['energy']}")

        if track.get("energy_category"):
            lines.append(f"#EXTENERGYCATEGORY:{track['energy_category']}")

        if track.get("loudness_lufs") is not None:
            lines.append(f"#EXTLOUDNESS:{track['loudness_lufs']}")

        if track.get("label"):
            lines.append(f"#EXTLABEL:{track['label']}")

        if track.get("key_confidence"):
            lines.append(f"#EXTKEYCONFIDENCE:{track['key_confidence']}")

        # –ò–º—è —Ñ–∞–π–ª–∞
        lines.append(track["filename"])
        lines.append("")  # –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –º–µ–∂–¥—É —Ç—Ä–µ–∫–∞–º–∏

    return "\n".join(lines)


# ============================================================================
# MAIN
# ============================================================================

logger.info("=" * 70)
logger.info("üìù M3U8 EXTENDED UPDATE")
logger.info("=" * 70)

# –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
logger.info(f"\nüìã –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∏–∑ {METADATA_FILE}...")
with open(METADATA_FILE, encoding="utf-8") as f:
    data = json.load(f)
    tracks = data["tracks"]

logger.info(f"‚úì –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(tracks)} —Ç—Ä–µ–∫–æ–≤")

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–æ–ª–µ–π
fields_stats = {
    "bpm": sum(1 for t in tracks if t.get("bpm")),
    "key": sum(1 for t in tracks if t.get("key")),
    "camelot": sum(1 for t in tracks if t.get("camelot")),
    "energy": sum(1 for t in tracks if t.get("energy")),
    "loudness_lufs": sum(1 for t in tracks if t.get("loudness_lufs") is not None),
}

logger.info("\nüìä –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ:")
for field, count in fields_stats.items():
    percentage = (count / len(tracks)) * 100
    logger.info(f"  {field:15} {count:2d}/{len(tracks)} ({percentage:5.1f}%)")

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ M3U8
logger.info("\nüéõÔ∏è  –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ M3U8...")
m3u8_content = generate_extended_m3u8(tracks, None)

# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ M3U8
main_m3u8 = DJ_SET_DIR / "techno_2025_extended.m3u8"
with open(main_m3u8, "w", encoding="utf-8") as f:
    f.write(m3u8_content)

logger.info(f"‚úì –û—Å–Ω–æ–≤–Ω–æ–π M3U8: {main_m3u8}")

# –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–∏–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª
original_m3u8 = DJ_SET_DIR / "techno_2025.m3u8"
with open(original_m3u8, "w", encoding="utf-8") as f:
    f.write(m3u8_content)

logger.info(f"‚úì –û–±–Ω–æ–≤–ª–µ–Ω –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π: {original_m3u8}")

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
logger.info("\n" + "=" * 70)
logger.info("üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê M3U8")
logger.info("=" * 70)
logger.info(f"–¢—Ä–µ–∫–æ–≤ –≤ –ø–ª–µ–π–ª–∏—Å—Ç–µ: {len(tracks)}")
logger.info(f"–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: {len(m3u8_content)} —Å–∏–º–≤–æ–ª–æ–≤")
logger.info(f"–°—Ç—Ä–æ–∫: {len(m3u8_content.splitlines())}")
logger.info("")
logger.info("–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ç–µ–≥–∏:")
logger.info("  ‚Ä¢ #EXTINF - –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ")
logger.info("  ‚Ä¢ #EXTGENRE - –∂–∞–Ω—Ä")
logger.info("  ‚Ä¢ #EXTBPM - —Ç–µ–º–ø (BPM)")
logger.info("  ‚Ä¢ #EXTKEY - –º—É–∑—ã–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á")
logger.info("  ‚Ä¢ #EXTCAMELOT - Camelot Wheel –∫–æ–¥")
logger.info("  ‚Ä¢ #EXTENERGY - —É—Ä–æ–≤–µ–Ω—å —ç–Ω–µ—Ä–≥–∏–∏ (1-10)")
logger.info("  ‚Ä¢ #EXTENERGYCATEGORY - –∫–∞—Ç–µ–≥–æ—Ä–∏—è —ç–Ω–µ—Ä–≥–∏–∏")
logger.info("  ‚Ä¢ #EXTLOUDNESS - –≥—Ä–æ–º–∫–æ—Å—Ç—å (LUFS)")
logger.info("  ‚Ä¢ #EXTLABEL - –ª–µ–π–±–ª")
logger.info("  ‚Ä¢ #EXTKEYCONFIDENCE - —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ Key detection")
logger.info("=" * 70)

logger.info("\n‚ú® M3U8 —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!")
logger.info("   –ì–æ—Ç–æ–≤ –∫ –∏–º–ø–æ—Ä—Ç—É –≤ DJ Pro AI / djay Pro / Rekordbox")
